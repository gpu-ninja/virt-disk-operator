# This hack exists mostly because of Docker for Mac, which does not support
# directly mounting linuxkit directories into containers. This assumes that 
# the node container is running in privileged and hostPID mode.
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: mount-hostdirs
  annotations:
    kapp.k14s.io/change-group: "koopt.gpu-ninja.com/hostdirs"
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: mount-hostdirs
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mount-hostdirs
    spec:
      hostPID: true
      containers:
        - name: mount-hostdirs
          image: debian:bookworm-slim
          command:
            - /bin/bash
            - -c
            - |
              set -e

              NODE_CONTAINER_PID=$(cut -d ' ' -f 4 /proc/$$/stat)
              NODE_CONTAINER_ROOT=$(nsenter -t ${NODE_CONTAINER_PID} -m /bin/sh -c 'mount | grep "overlay on / type overlay" | sed -n -e "s/.*upperdir=\(.*\)\/diff.*/\1\/merged/p"')

              nsenter -t 1 -m /bin/sh -c "
                if [ -z \"$(find \"\${NODE_CONTAINER_ROOT}/host\" -type f -print -quit 2>/dev/null)\" ]; then
                  echo 'Mounting host filesystem into node container'
                  
                  echo 'Mounting /dev from host'
                  mkdir -p \"${NODE_CONTAINER_ROOT}/host/dev\"
                  mount --bind /dev \"${NODE_CONTAINER_ROOT}/host/dev\"
                  mount --make-rshared \"${NODE_CONTAINER_ROOT}/host/dev\"

                  echo 'Mounting /run from host'
                  mkdir -p \"${NODE_CONTAINER_ROOT}/host/run\"
                  mount --bind /run \"${NODE_CONTAINER_ROOT}/host/run\"
                  mount --make-rshared \"${NODE_CONTAINER_ROOT}/host/run\"

                  if [ ! -z \"\$(find /lib/modules -type f -print -quit 2>/dev/null)\" ]; then                
                    echo 'Mounting /lib/modules from host'
                    mkdir -p \"${NODE_CONTAINER_ROOT}/host/lib/modules\"
                    mount --bind /lib/modules \"${NODE_CONTAINER_ROOT}/host/lib/modules\"
                  fi
                fi
              "

              nsenter -t ${NODE_CONTAINER_PID} -m /bin/sh -c "
                if [ ! -z \"\$(find /host/lib/modules -type f -print -quit 2>/dev/null)\" ]; then
                  if [ -z \"\$(find /lib/modules -type f -print -quit 2>/dev/null)\" ]; then
                    echo 'Bind mounting /lib/modules'
                    mkdir -p /lib/modules
                    mount --bind /host/lib/modules /lib/modules
                    mount -o bind,remount,ro /lib/modules
                  fi
                fi

                if [ ! -z \"\$(find /host/run/lvm -type f -print -quit 2>/dev/null)\" ]; then
                  if [ -z \"\$(find /run/lvm -type f -print -quit 2>/dev/null)\" ]; then
                    echo 'Bind mounting /run/lvm'
                    mkdir -p /run/lvm
                    mount --bind /host/run/lvm /run/lvm
                    mount --make-rshared /run/lvm
                  fi
                fi

                if [ ! -z \"\$(find /host/run/lock/lvm -type f -print -quit 2>/dev/null)\" ]; then
                  if [ -z \"\$(find /run/lock/lvm -type f -print -quit 2>/dev/null)\" ]; then
                    echo 'Bind mounting /run/lock/lvm'
                    mkdir -p /run/lock/lvm
                    mount --bind /host/run/lock/lvm /run/lock/lvm
                    mount --make-rshared /run/lock/lvm
                  fi
                fi
              "

              sleep infinity
          securityContext:
            privileged: true
          resources:
            requests:
              memory: "16Mi"
              cpu: "10m"
            limits:
              memory: "32Mi"
              cpu: "50m"